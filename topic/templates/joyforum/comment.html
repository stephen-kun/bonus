{% extends "joyforum/base.html" %}
{% load static %}
{% load forum_tags i18n %}
{% load wxwraper %}
{#{% load emoji_tags %}#}

{% block cssext %}
<style>
    .tupianpanel{
        height:5rem;
        width: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        border-top: 1px solid #e8e8e8;
    }

    .tupianpanel ul{
        list-style: none;
    }

    .tupianpanel ul li{
        float:left;
        width: 2rem;
        height: 2rem;
        margin: 0.2rem;
    }

    .tupianpanel ul li *{
        font-size: 1.5rem!important;
    }

    .tupianpanel ul li.last .icon:focus{
        color: #ff7a00!important;
    }

        #biaoqing_container{
        list-style:none;
        padding: 0.1rem;
        overflow-x: hidden;
        overflow-y: auto;
        margin-top: 0;
        height: 100%;
    }

    #biaoqing_container li{
        float: left;
        width: 1.2rem;
        height:1.2rem;
        margin: 0.1rem;
    }

        #biaoqing_container li img{
            height: 1.1rem;
            width: 1.1rem;
        }

    .textarea{
        width: 100%;
        height: 100%;
        resize: none;
        margin: 0.1rem 0;
        border: 0px;
        outline: 0px solid transparent;
        background: white;
    }

    .textarea img{
        height: 0.9rem;
        width: 0.9rem;
    }
    .textarea:focus{
        outline:none;
    }
</style>
{% endblock %}

{% block headerjs %}
    <script type='text/javascript' src='{% static "js/util.no-min.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/marked.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/my_editor_image_upload.no-min.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/editor.no-min.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/emoji_list.no-min.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/atwho/jquery.atwho.min.js" %}' charset='utf-8'></script>
    <script type='text/javascript' src='{% static "js/atwho/jquery.caret.min.js" %}' charset='utf-8'></script>
        <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
{#    <script src="{% static 'emoji/js/emoji.js' %}"></script>#}
{% endblock %}

{% block barheader %}
    <header class="bar bar-nav">
        <a class="button button-link button-nav pull-left external" id="cancelcomment" href="{{ topic.get_bookmark_url|wxurl_wraper }}">
            &nbsp;&nbsp;取消
        </a>
        <a class="button button-nav pull-right external" id="sendcomment">
            发 表
        </a>

        <h1 class="title">发评论</h1>

    </header>

{% endblock %}

{% block navbar %}
    <nav class="bar bar-tab" id="commentbottombar">
        <a class="tab-item external" href="#" id="tupianbtn">
            <span class="icon iconfont icon-tupian"></span>
        </a>
        <a class="tab-item external" href="#" id="biaoqingbtn">
            <span class="icon iconfont icon-biaoqing"></span>

        </a>
        <div class="tupianpanel" style="display: none;">
            <ul id="tupian_container">
                <li class="last"><a href="#" class="js-box-image icon iconfont icon-tianjiatupian"></a></li>
            </ul>
            <div style="clear: both;"></div>
        </div>
        <div class="biaoqingpanel" style="display: none;">
            <ul id="biaoqing_container" class="scroll">

            </ul>
            <div style="clear: both;"></div>
        </div>
    </nav>
{% endblock %}

{% block page %}
    <div class="page-current" style="height: 100%">
        <form action="{% url "wx:wx-comment-publish" topic_id=topic.id %}" method="post" class="js-reply"
              id="wxsendcommentform">
            {% csrf_token %}
            {% if next %}<input type="hidden" name="next" value="{{ next }}"/>{% endif %}
            <input type="hidden" name="imagelist" id="imagelist">
            <div style="display:none;">
            {% for field in form %}
                {{ field.errors }}
                {{ field }}
            {% endfor %}
            </div>
            <div class="textarea" contenteditable="true">

            </div>
        </form>
    </div>
{% endblock %}

{% block jsext %}

    <script>
        $(function () {
            $form = $("#wxsendcommentform");
            $form.on('submit', function (e, letSubmit) {
                // Let the form submitting itself
                if (letSubmit) {
                    return true;
                }
                e.preventDefault();
                $("#wxsendcommentform textarea").val($("#wxsendcommentform .textarea").html());
                $.post(this.action, $form.serialize(), function (res) {
                    if (res.result == "ok") {
                        window.location.href = "{{ topic.get_bookmark_url|wxurl_wraper }}";
                    } else if (res.result == 'nok') {
                        alert(res.errorinfo);
                    }

                })
            });

             $('#sendcomment').tap(function(){
                 var imagelist = []
                 $('#tupian_container li.item').each(function(index,value){
                     imagelist.push($(value).find("img").attr("cmid"));
                 });
                $("#imagelist").val(imagelist);
                $("#wxsendcommentform").submit();
            });

            $("#tupianbtn").on('click',function(){
                if($("#biaoqingbtn").hasClass("active")) {
                    $(".biaoqingpanel").hide();
                    $("#biaoqingbtn").removeClass("active");
                }
                if($(this).hasClass("active")){
                    $("#commentbottombar").css("height", "2.5rem");
                    $(".content").css("bottom", "2.5rem");
                    $(".tupianpanel").hide();
                    $(this).removeClass("active");
                }
                else {
                    $("#commentbottombar").css("height", "7.5rem");
                    $(".content").css("bottom", "7.5rem");
                    $(".tupianpanel").show();
                    $(".biaoqingpanel").hide();
                    $(this).addClass("active");
                }
            });

            $("#biaoqingbtn").on('click',function(){
                if($("#tupianbtn").hasClass("active")) {
                    $(".tupianpanel").hide();
                    $("#tupianbtn").removeClass("active");
                }
                if($(this).hasClass("active")){
                    $("#commentbottombar").css("height", "2.5rem");
                    $(".content").css("bottom", "2.5rem");
                    $(".biaoqingpanel").hide();
                    $(this).removeClass("active");
                }
                else {
                    $("#commentbottombar").css("height", "8.5rem");
                    $(".content").css("bottom", "8.5rem");
                    $(".biaoqingpanel").show();
                    $(".tupianpanel").hide();
                    $(this).addClass("active");
                }
            });

            $("#cancelcomment").tap(function(){
                $('#tupian_container li.item').each(function(index,value){   //TODO: DELETE IMAGE WHEN CANCEL

                });
            });
        });

    jQuery( document ).ready(function() {

        marked.setOptions( {
            renderer: new marked.Renderer(),
            gfm: true,
            tables: false,
            breaks: true,
            pedantic: false,
            sanitize: true,
            smartLists: false,
            smartypants: false
        } );

        jQuery( '#tupian_container' ).editor_image_upload( {
			csrfToken: "{{ csrf_token }}",
			target: "{% url "comment:image-upload-ajax" %}",
			placeholderText: "{% trans "uploading {image_name}" %}"
		    });

{#        Emoji.setDataUrl('{% url 'emoji:list.json' %}').load();#}
{##}
{#        var emojisobj = jQuery.parseJSON(localStorage.emojis);#}
{#        jQuery.each(emojisobj,function(idx,val){#}
{#            $("#biaoqing_container").append("<li emoji='"+idx+"'><img src='"+val+"'></li>");#}
{#        });#}
{##}
{#        jQuery("#biaoqing_container li").on("click",function(){#}
{#            var emoji = $(this).attr("emoji");#}
{#            $("#wxsendcommentform .textarea").append(":"+emoji+":");#}
{#        });#}


        });


    </script>

{% endblock %}

