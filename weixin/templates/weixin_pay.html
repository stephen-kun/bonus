<!-- 支付 -->
{% extends "_bonus_base.html" %}

{% block body %}
<body class="qubaba_hsbj bottom_40">

{% block content %}
<article>
<section>
  	<div class="issue-top Angel-voucher-mt">
    	
        <div class="Angel Angel-voucher-img">
        	<div class="blades">
                <div class="Angel-baby Angel-voucher130"></div>
            </div>
            <h2><img src="{{consumer.picture}}"></h2>
        </div>
        <h3>{{consumer.name}}</h3>
        <style type="text/css">
			.blades{animation: spin 100s linear infinite;}
		</style>
    </div>	
</section>

<section>
    <div class="box-food qbbaise box-food-mt">
    	<ul>
			{% for goods in good_list %}
        	<li>
            	<h4><span class="rfloat"><font class="qbred">{{goods.number}}</font>{{goods.unit}}</span>{{goods.name}}<span class="box-food-gray">({{goods.price}}元/{{goods.unit}})</span></h4>
            </li>
			{% endfor %}
            <li>
            	<h4><span class="rfloat"><font class="qbred">{{total_money}}</font>元</span>消费总额</h4>
            </li>
        </ul>
    </div>
	
    <div class="queding">
        <span id='weixin' ><input type="button" class="green" value="微信支付" onclick="callPay()"></span>
    </div>
	
</section>

<script type="text/javascript" >

function wx_pay_result(){
	var url = '{{ajax_request_url}}';
	var openid = '{{consumer.open_id}}';
	var prepay_id = '{{prepay_id}}';
	var timer = setInterval(function(){
		var xmlhttp = new XMLHttpRequest();
		var data = '{"openid":"OPENID","prepay_id":"PREPAY_ID", "action":"ajax_weixin_pay"}';
		data = data.replace(/OPENID/, openid).replace(/PREPAY_ID/, prepay_id);
		
		xmlhttp.onreadystatechange=function()
		{
			if(xmlhttp.readyState==4 && xmlhttp.status==200)
			{
				// 实现跳转
				var response = JSON.parse(xmlhttp.responseText);
				if(response.status == 'SUCCESS' && response.result == 'SUCCESS'){
					$("#weixin").html('<input type="button" class="gray" value="微信支付" >');
					window.location.href = '{{pay_suc_url}}';	
					clearInterval(timer);
				}

			}
		}

		xmlhttp.open("POST", url, true);
		xmlhttp.send(data);			
	}, 2000);
}

function onBridgeReady(){
	WeixinJSBridge.invoke(
		'getBrandWCPayRequest',
		{{pay_param|safe}},
		function(res){
			if (res.err_msg == "get_brand_wcpay_request:ok") {
				wx_pay_result();				
			}
		}
		
	);
}

function callPay(){
	if (typeof WeixinJSBridge == "undefined"){
		if( document.addEventListener ){
			document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
		}else if (document.attachEvent){
			document.attachEvent('WeixinJSBridgeReady', onBridgeReady); 
			document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
		}
	}else{
		onBridgeReady();
	} 	
}

</script>

</article>
{% endblock %}

{% block menu %}
{% include '_menu.html' %}
{% endblock %}
</body>
{% endblock %}